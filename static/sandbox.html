<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <title>AI äººæ‰æ¨¡å‹éŠæ¨‚å ´ï½œè‡ªç”±åˆ†ç¾¤ç‰ˆæœ¬</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #f3fbf7;
            --panel: #dde7f5;
            --card: #f5f7fb;
            --card-strong: #e4ecf8;
            --border: #7c8ba5;
            --accent: #f97316;
            --accent-soft: #ffedd5;
            --text: #0f172a;
            --muted: #4b5563;
            --radius-xl: 22px;
            --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.18);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Noto Sans TC",
                "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #e0f2fe 0, #f3fbf7 40%, #ecfdf3 100%);
            color: var(--text);
            line-height: 1.7;
            font-size: 18px;
        }

        .shell {
            max-width: 1120px;
            margin: 28px auto 40px;
            padding: 0 16px;
        }

        header {
            background: rgba(15, 23, 42, 0.96);
            color: #e5e7eb;
            padding: 18px 20px;
            border-radius: 26px;
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 16px;
        }

        header .title-block {
            flex: 1 1 260px;
        }

        header h1 {
            margin: 0 0 6px;
            font-size: 1.8rem;
            letter-spacing: 0.03em;
        }

        header p {
            margin: 0;
            font-size: 0.98rem;
            color: #cbd5f5;
        }

        header .nav {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 210px;
            align-items: flex-end;
            font-size: 0.96rem;
        }

        header .nav a {
            color: #e5e7eb;
            text-decoration: none;
            opacity: 0.9;
        }

        main {
            margin-top: 20px;
            display: grid;
            grid-template-columns: minmax(0, 3fr) minmax(0, 4fr);
            gap: 18px;
        }

        @media (max-width: 960px) {
            main {
                grid-template-columns: minmax(0, 1fr);
            }

            header .nav {
                align-items: flex-start;
            }
        }

        .panel {
            background: var(--panel);
            border-radius: var(--radius-xl);
            border: 1px solid rgba(148, 163, 184, 0.9);
            padding: 16px;
            box-shadow: var(--shadow-soft);
        }

        .panel h2 {
            margin: 0 0 8px;
            font-size: 1.35rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .badge {
            font-size: 0.9rem;
            padding: 3px 9px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.12);
            color: #e5e7eb;
        }

        .desc {
            margin: 0 0 10px;
            font-size: 0.96rem;
            color: var(--muted);
        }

        .step-card {
            background: var(--card);
            border-radius: 18px;
            border: 1px solid rgba(148, 163, 184, 0.9);
            padding: 12px 14px;
            margin-top: 10px;
        }

        .step-title {
            font-weight: 600;
            font-size: 1.05rem;
            margin-bottom: 4px;
        }

        .note {
            font-size: 0.92rem;
            color: var(--muted);
            margin: 4px 0 0;
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            border-radius: 999px;
            padding: 3px 10px;
            border: 1px solid rgba(148, 163, 184, 0.9);
            background: #ffffff;
            color: var(--muted);
            margin-top: 6px;
        }

        .status-pill.ok {
            border-color: #16a34a;
            color: #166534;
        }

        .status-pill.warn {
            border-color: #f97316;
            color: #9a3412;
        }

        .k-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        /* k é¸æ“‡ pill æŒ‰éˆ• */
        .k-pill {
            min-width: 72px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.9);
            background: #ffffff;
            /* æœªé¸ï¼šç™½åº• */
            color: #0f172a;
            /* æœªé¸ï¼šæ·±è‰²æ–‡å­—ï¼Œä¸€å®šçœ‹å¾—åˆ° */
            padding: 4px 12px;
            font-size: 0.94rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 0 0 rgba(0, 0, 0, 0);
            transition: all 0.18s ease-out;
        }

        .k-pill:hover {
            box-shadow: 0 6px 12px rgba(15, 118, 110, 0.18);
        }

        .k-pill.active {
            background: #0f766e;
            /* å·²é¸ï¼šç¶ åº•ç™½å­— */
            color: #ffffff;
            border-color: #0f766e;
            box-shadow: 0 10px 20px rgba(15, 118, 110, 0.4);
        }


        input[type="number"] {
            font-size: 0.94rem;
            padding: 4px 8px;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.9);
            background: #f9fafb;
            width: 80px;
        }

        button {
            border-radius: 999px;
            border: none;
            padding: 8px 15px;
            font-size: 0.96rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(to right, #0f766e, #22c55e);
            color: white;
            box-shadow: 0 8px 16px rgba(34, 197, 94, 0.4);
            margin-top: 10px;
        }

        button:disabled {
            opacity: 0.6;
            cursor: default;
            box-shadow: none;
        }

        /* å°å‹åœ–å³ä¸Šè§’çš„æ”¾å¤§æŒ‰éˆ• */
        .icon-btn {
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.7);
            background: #ffffff;
            color: #374151;
            padding: 4px 12px;
            /* ç¨å¾®åŠ å¤§ä¸€é» paddingï¼Œæ¯”è¼ƒåƒè† å›Š */
            font-size: 0.85rem;
            /* å­—ç¨å¾®æ”¾å¤§ä¸€é»é» */
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            white-space: nowrap;
            /* â­ é—œéµï¼šæ•´å¥ä¸æ›è¡Œ */
        }

        .icon-btn:hover {
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.18);
        }

        /* æ¨™é¡Œï¼‹æŒ‰éˆ•åŒä¸€è¡Œé å…©å´ */
        .step-title-with-icon {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        /* é›·é”åœ–æ”¾å¤§ç”¨çš„ modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            /* é è¨­é—œé–‰ */
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal-content {
            background: #f9fafb;
            border-radius: 20px;
            padding: 12px 14px 16px;
            max-width: 860px;
            width: 90%;
            max-height: 90vh;
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.98rem;
        }

        .modal-body {
            flex: 1;
            min-height: 360px;
        }

        .modal-body canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* æ”¾å¤§ç‰ˆé›·é”åœ–å®¹å™¨é«˜åº¦å†å¤§ä¸€é» */
        .cluster-radar-wrap.global {
            height: 260px;
        }





        /* å³å´çµæœå€ */
        .cluster-summary {
            background: #0f172a;
            color: #e5e7eb;
            border-radius: 20px;
            padding: 14px 16px;
            margin-bottom: 10px;
        }

        .cluster-summary h3 {
            margin: 0 0 4px;
            font-size: 1.1rem;
        }

        .cluster-summary p {
            margin: 0;
            font-size: 0.95rem;
            color: #cbd5f5;
        }

        .cluster-list {
            display: grid;
            grid-template-columns: minmax(0, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .cluster-card {
            background: #f9fafb;
            border-radius: 16px;
            padding: 10px 12px;
            border: 1px solid rgba(148, 163, 184, 0.9);
            font-size: 0.95rem;
        }

        .cluster-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .cluster-name {
            font-weight: 650;
        }

        .cluster-tag {
            font-size: 0.82rem;
            border-radius: 999px;
            padding: 2px 8px;
            background: #e0f2fe;
            color: #0369a1;
        }

        .cluster-body p {
            margin: 2px 0;
            font-size: 0.9rem;
        }

        /* æ¯ç¾¤çš„å°ç¸¾æ•ˆé€²åº¦æ¢ */
        .cluster-perf-bar-wrap {
            margin-top: 6px;
        }

        .cluster-perf-bar-bg {
            position: relative;
            width: 100%;
            height: 6px;
            border-radius: 999px;
            background: #e5e7eb;
            /* æ·ºç°åº• */
            overflow: hidden;
        }

        .cluster-perf-bar-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            border-radius: 999px;
            /* é¡è‰²æœƒåœ¨ JS è£¡ä¾é«˜æ–¼ / ä½æ–¼å¹³å‡æ±ºå®š */
        }

        .cluster-perf-bar-label {
            margin-top: 2px;
            font-size: 0.82rem;
            color: #6b7280;
        }




        .cluster-baseline-box {
            margin-top: 10px;
            margin-bottom: 12px;
            padding: 10px 12px;
            border-radius: 14px;
            background: #f1faf7;
            border: 1px dashed rgba(15, 118, 110, 0.5);
            font-size: 0.9rem;
        }

        .cluster-baseline-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #0f766e;
        }

        .cluster-baseline-list {
            margin: 0;
            padding-left: 1.1rem;
        }

        .cluster-feature-block {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed #d1d5db;
        }

        .cluster-feature-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .cluster-feature-list {
            margin: 0;
            padding-left: 1.1rem;
            font-size: 0.88rem;
            color: #374151;
        }

        .theme-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-top: 10px;
        }

        .theme-select {
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.9);
            background: #ffffff;
            font-size: 0.9rem;
        }


        #overall-chart-container {
            margin-top: 8px;
            height: 260px;
            /* å›ºå®šé«˜åº¦ */
            position: relative;
        }

        #overall-chart-container canvas {
            width: 100% !important;
            /* è®“ Chart.js å¡«æ»¿å®¹å™¨ */
            height: 100% !important;
        }

        /* åˆ†ç¾¤å“è³ªå°ç‡ˆè™Ÿ */
        .quality-pill {
            margin-left: 8px;
            font-size: 0.82rem;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid transparent;
            vertical-align: middle;
        }

        .quality-na {
            background: rgba(15, 23, 42, 0.06);
            color: #4b5563;
            border-color: rgba(148, 163, 184, 0.7);
        }

        .quality-good {
            background: #dcfce7;
            color: #166534;
            border-color: #16a34a;
        }

        .quality-ok {
            background: #fef9c3;
            color: #92400e;
            border-color: #facc15;
        }

        .quality-bad {
            background: #fee2e2;
            color: #b91c1c;
            border-color: #fca5a5;
        }

        /* å¿«ç…§åˆ— */
        .snapshot-row {
            margin-top: 6px;
            margin-bottom: 8px;
            /* â­ èˆ‡ä¸‹æ–¹å…§å®¹æ‹‰é–‹ä¸€é» */
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            font-size: 0.88rem;
        }

        /* å¿«ç…§æ¯”è¼ƒå¡ï¼ˆ1-3 è£¡çš„å°å¡ï¼‰ */
        .snapshot-compare-card {
            margin-top: 8px;
            background: #eef2ff;
            border-radius: 14px;
            padding: 10px 12px;
            border: 1px solid rgba(129, 140, 248, 0.7);
        }

        .snapshot-compare-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* å·¦é‚Š 1-4ï¼šé›·é”åœ– + å¹³å‡ç¸¾æ•ˆæ’ç‰ˆ */
        .global-chart-row {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .global-chart-row>div {
            flex: 1 1 260px;
        }

        /* å…¨ç¾¤é›·é”åœ–ç”¨è¼ƒé«˜çš„å®¹å™¨ */
        .cluster-radar-wrap.global {
            height: 260px;
        }





        .snapshot-btn {
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.9);
            background: #fff;
            color: #0f172a;
            box-shadow: 0 4px 8px rgba(15, 23, 42, 0.12);
            padding: 4px 10px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .snapshot-btn:disabled {
            opacity: 0.4;
            box-shadow: none;
            cursor: default;
        }

        .snapshot-label {
            color: #4b5563;
        }

        /* æ¯ç¾¤é›·é”åœ–å®¹å™¨ */
        .cluster-radar-wrap {
            margin-top: 8px;
            height: 220px;
            position: relative;
        }

        .cluster-radar-wrap canvas {
            width: 100% !important;
            height: 100% !important;
        }

        #radar-chart-card {
            display: none;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


</head>

<body>
    <div class="shell">
        <header>
            <div class="title-block">
                <h1>AI äººæ‰æ¨¡å‹éŠæ¨‚å ´ï½œè‡ªç”±åˆ†ç¾¤ç‰ˆæœ¬</h1>
                <p>å…±ç”¨åŒä¸€ä»½ç ”ç©¶è³‡æ–™ï¼Œåªèª¿æ•´ k å€¼ï¼ˆç¾¤æ•¸ï¼‰ï¼Œè§€å¯Ÿä¸åŒåˆ†ç¾¤ä¸‹çš„è¼ªå»“è®ŠåŒ–ã€‚</p>
            </div>
            <div class="nav">
                <a href="index.html" class="breadcrumb-link" data-keep-api>â† å›åˆ°æ¨¡å‹èªªæ˜é </a>
                <a href="predict.html" class="breadcrumb-link" data-keep-api>ğŸš€ å‰å¾€å¯¦é©—ç”¨é æ¸¬ Demo</a>
            </div>
        </header>

        <main>
            <!-- å·¦ï¼šè¨­å®šåˆ†ç¾¤ -->
            <section class="panel">
                <h2>Step 1ï¼šè¨­å®šåˆ†ç¾¤åƒæ•¸ <span class="badge">è‡ªç”±ç‰ˆ</span></h2>
                <p class="desc">
                    æœ¬é æœƒæ²¿ç”¨åœ¨ Demo é ä¸Šå‚³ä¸¦è¨“ç·´å¥½çš„è³‡æ–™èˆ‡å‰è™•ç†ï¼Œåƒ…èª¿æ•´ <strong>kï¼ˆç¾¤æ•¸ï¼‰</strong>ï¼Œè§€å¯Ÿå„ç¾¤çš„å¹³å‡ç¸¾æ•ˆèˆ‡å¤§è‡´è¼ªå»“ã€‚
                </p>

                <div id="model-status" class="status-pill warn">
                    â³ æ­£åœ¨æª¢æŸ¥æ¨¡å‹ç‹€æ…‹â€¦
                </div>

                <!-- 1-2. k å€¼è¨­å®š -->
                <div class="step-card">
                    <div class="step-title">1-2. é¸æ“‡åˆ†ç¾¤æ•¸ k</div>
                    <p class="note">
                        å»ºè­°å…ˆè©¦ <strong>3ï½5 ç¾¤</strong>ï¼Œç¾¤æ•¸å¤ªå¤šæœƒè®“æ¯ç¾¤äººå¤ªå°‘ã€è¼ªå»“ä¸å¥½è®€ã€‚ä½ ä¹Ÿå¯ä»¥æ‰‹å‹•è¼¸å…¥å…¶ä»–æ•¸å­—ã€‚
                    </p>

                    <div class="k-row">
                        <button type="button" class="k-pill active" data-k="3">3 ç¾¤</button>
                        <button type="button" class="k-pill" data-k="4">4 ç¾¤</button>
                        <button type="button" class="k-pill" data-k="5">5 ç¾¤</button>
                        <span style="font-size:0.9rem;">æˆ–è‡ªè¨‚ï¼š</span>
                        <input type="number" id="k-input" value="3" min="2" max="10" />
                    </div>

                    <div class="theme-row">
                        <span style="font-size:0.9rem;">è§€å¯Ÿä¸»é¡Œï¼š</span>
                        <select id="theme-select" class="theme-select">
                            <option value="all">ğŸ§© å…¨éƒ¨æŒ‡æ¨™ä¸€èµ·çœ‹</option>
                            <option value="workload">ğŸ“Š å·¥ä½œè² è·é›·é”ï¼ˆå·¥æ™‚/åŠ ç­/å°ˆæ¡ˆ/ç—…å‡ï¼‰</option>
                            <option value="pay">ğŸ’° è–ªè³‡ï¼†è³‡æ­·ï¼ˆè–ªæ°´/å¹´è³‡/å¹´é½¡ï¼‰</option>
                            <option value="growth">ğŸŒ± æˆé•·æ„Ÿï¼†æ»¿æ„åº¦ï¼ˆè¨“ç·´/æ»¿æ„åº¦ï¼‰</option>
                            <option value="team">ğŸ¤ åœ˜éšŠå‹æ…‹ï¼ˆåœ˜éšŠå¤§å°/é è·é »ç‡ï¼‰</option>
                        </select>
                    </div>

                    <button type="button" id="btn-run-cluster">ğŸ”„ é‡æ–°åˆ†ç¾¤</button>
                    <p class="note" id="cluster-status">å°šæœªåŸ·è¡Œåˆ†ç¾¤ã€‚</p>
                </div>

                <!-- 1-3. åˆ†ç¾¤å¿«ç…§èˆ‡ç‰ˆæœ¬æ¯”è¼ƒ -->
                <div class="step-card">
                    <div class="step-title">1-3. åˆ†ç¾¤å¿«ç…§èˆ‡ç‰ˆæœ¬æ¯”è¼ƒ</div>

                    <div class="snapshot-row">
                        <button type="button" id="btn-save-snapshot" class="snapshot-btn" disabled>
                            ğŸ“¸ æŠŠé€™æ¬¡çµæœå­˜æˆå¿«ç…§
                        </button>
                        <button type="button" id="btn-compare-snapshot" class="snapshot-btn" disabled>
                            ğŸ” èˆ‡å¿«ç…§ç‰ˆæœ¬æ¯”è¼ƒ
                        </button>
                        <span id="snapshot-label" class="snapshot-label">
                            ç›®å‰å°šæœªå„²å­˜å¿«ç…§
                        </span>
                    </div>

                    <div id="snapshot-compare-card" class="snapshot-compare-card" style="display:none;">
                        <div class="snapshot-compare-title">
                            <span>ğŸ“Š èˆ‡å¿«ç…§ç‰ˆæœ¬æ¯”è¼ƒ</span>
                        </div>
                        <div id="snapshot-compare-body" class="note"></div>
                    </div>
                </div>

                <!-- 1-4. å„ç¾¤æ•´é«”è¼ªå»“ï¼šé›·é”åœ–ï¼‹å¹³å‡ç¸¾æ•ˆ -->
                <div class="step-card" id="radar-chart-card">
                    <div class="step-title-with-icon">
                        <div class="step-title">1-4. å„ç¾¤æ•´é«”è¼ªå»“ï¼ˆé›·é”åœ–ï¼‹å¹³å‡ç¸¾æ•ˆï¼‰</div>
                        <button type="button" id="btn-open-radar" class="icon-btn">
                            ğŸ” æ”¾å¤§æª¢è¦–
                        </button>
                    </div>

                    <p class="note">
                        é›·é”åœ–é¡¯ç¤ºå„ç¾¤åœ¨æ‰€æœ‰æ•¸å€¼æŒ‡æ¨™ä¸Šç›¸å°ã€Œå…¨é«”å¹³å‡ã€çš„æ¯”ä¾‹ï¼ˆ1x è¡¨ç¤ºå·®ä¸å¤šï¼‰ã€‚
                        å³é‚Šé•·æ¢åœ–å‰‡ä¾å¹³å‡ç¸¾æ•ˆç”±é«˜åˆ°ä½æ’åˆ—ã€‚
                    </p>

                    <div class="global-chart-row">
                        <!-- å·¦ï¼šå°é›·é”åœ– -->
                        <div class="cluster-radar-wrap global">
                            <canvas id="multi-radar-canvas"></canvas>
                        </div>
                        <!-- å³ï¼šå„ç¾¤å¹³å‡ç¸¾æ•ˆï¼ˆæ©«æ¢åœ–ï¼‰ -->
                        <div id="overall-chart-container">
                            <canvas id="overall-chart-canvas"></canvas>
                        </div>
                    </div>

                    <p class="note" id="radar-highlight-note"></p>
                </div>





                <!-- é›·é”åœ–æ”¾å¤§æª¢è¦– Modal -->
                <div id="radar-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <span>å„ç¾¤é›·é”åœ–ï¼ˆæ”¾å¤§æª¢è¦–ï¼‰</span>
                            <button type="button" id="btn-close-radar" class="icon-btn">âœ• é—œé–‰</button>
                        </div>
                        <div class="modal-body">
                            <canvas id="multi-radar-canvas-large"></canvas>
                        </div>
                    </div>
                </div>

            </section>





            <!-- å³ï¼šå„ç¾¤çµæœ -->
            <section class="panel">
                <h2>
                    Step 2ï¼šè§€å¯Ÿå„ç¾¤è¼ªå»“èˆ‡å¹³å‡ç¸¾æ•ˆ
                    <span id="cluster-quality-pill" class="quality-pill quality-na">
                        å“è³ªï¼šå°šæœªåˆ†æ
                    </span>
                </h2>

                <div class="cluster-summary" id="cluster-summary">
                    <h3>å°šæœªåŸ·è¡Œåˆ†ç¾¤</h3>
                    <p>è«‹å…ˆåœ¨å·¦å´é¸æ“‡ k å€¼ï¼ŒæŒ‰ä¸‹ã€Œé‡æ–°åˆ†ç¾¤ã€ã€‚</p>
                </div>

                <div id="cluster-list-wrapper">
                    <div class="step-card">
                        <p class="note">
                            é‚„æ²’æœ‰ä»»ä½•çµæœã€‚å®Œæˆç¬¬ä¸€æ¬¡åˆ†ç¾¤å¾Œï¼Œé€™è£¡æœƒä¾åºåˆ—å‡ºæ¯ä¸€ç¾¤çš„äººæ•¸ã€å¹³å‡ç¸¾æ•ˆèˆ‡ç°¡çŸ­èªªæ˜ã€‚
                        </p>
                    </div>
                </div>




            </section>






        </main>
    </div>

    <script>
        function resolveApiBase() {
            try {
                const url = new URL(window.location.href);
                const apiParam = url.searchParams.get("api");

                // è‹¥ç¶²å€ä¸Šæœ‰ ?api=ï¼Œå„ªå…ˆç”¨å®ƒä¸¦è¨˜åˆ° localStorage
                if (apiParam) {
                    const clean = apiParam.replace(/\/+$/, "");
                    localStorage.setItem("talent_api_base", clean);
                    return clean;
                }

                // è‹¥æ›¾ç¶“å­˜éï¼Œå°±æ²¿ç”¨
                const saved = localStorage.getItem("talent_api_base");
                if (saved) {
                    return saved;
                }

                // å¦‚æœå‰å¾Œç«¯æ˜¯åŒä¸€å€‹ domainï¼ˆä¾‹å¦‚ä½ ä¹‹å¾Œæ”¾åˆ°åŒä¸€å° serverï¼‰
                if (window.location.protocol.startsWith("http")) {
                    return window.location.origin;  // ä¾‹å¦‚ https://yourhost.com
                }

                // é–‹ç™¼æ™‚æˆ– file:// å°±æŒ‡åˆ°æœ¬æ©Ÿ 8000
                return "http://127.0.0.1:8000";
            } catch (e) {
                console.warn("è§£æ API_BASE å¤±æ•—ï¼Œé€€å›æœ¬æ©Ÿ 8000ï¼š", e);
                return "http://127.0.0.1:8000";
            }
        }

        const API_BASE = resolveApiBase();



        // è®“ ?api= åƒæ•¸åœ¨é é¢ä¹‹é–“è‡ªå‹•å»¶çºŒ
        (function propagateApiParam() {
            try {
                const url = new URL(window.location.href);
                const apiParam = url.searchParams.get("api");
                if (!apiParam) return;

                document.querySelectorAll("a[data-keep-api]").forEach((a) => {
                    const target = new URL(a.getAttribute("href"), window.location.href);
                    target.searchParams.set("api", apiParam);
                    a.href = target.toString();
                });
            } catch (e) {
                console.warn("propagateApiParam å¤±æ•—ï¼š", e);
            }
        })();






        const FEATURE_LABELS = {
            Monthly_Salary: "æœˆè–ª",
            Age: "å¹´é½¡",
            Years_At_Company: "å¹´è³‡",
            Work_Hours_Per_Week: "æ¯é€±å·¥æ™‚",
            Overtime_Hours: "åŠ ç­æ™‚æ•¸",
            Sick_Days: "è«‹ç—…å‡å¤©æ•¸",
            Remote_Work_Frequency: "é è·é »ç‡",
            Team_Size: "åœ˜éšŠäººæ•¸",
            Projects_Handled: "è² è²¬å°ˆæ¡ˆæ•¸",
            Training_Hours: "è¨“ç·´æ™‚æ•¸",             // æ–°å¢
            Employee_Satisfaction_Score: "æ»¿æ„åº¦", // æ–°å¢
            Performance_Score: "ç¸¾æ•ˆåˆ†æ•¸"
        };

        // æ ¹æ“šè©²ç¾¤å¹³å‡ç¸¾æ•ˆ vs æ•´é«”ï¼Œç”Ÿå‡ºä¸€å€‹æš±ç¨±ï¼‹ emoji
        function getClusterNickname(cluster, overallMean) {
            const perf = cluster.mean_performance ?? overallMean;
            const ratio = overallMean ? perf / overallMean : 1;

            let emoji = "âš–ï¸";
            let label = "ä¸­ç­‰è¼ªå»“";

            if (ratio >= 1.10) {
                emoji = "ğŸŸ¢";
                label = "é«˜ç¸¾æ•ˆç¾¤";
            } else if (ratio <= 0.90) {
                emoji = "ğŸŸ ";
                label = "éœ€é—œæ³¨ç¾¤";
            }

            return { emoji, label };
        }

        // ç”¨è©²ç¾¤å·®ç•°æœ€å¤§çš„å¹¾å€‹æŒ‡æ¨™ï¼Œçµ„æˆä¸€å¥ã€Œç¾¤çµ„å°æ•…äº‹ã€
        function makeStoryLine(displayItems) {
            if (!displayItems || !displayItems.length) return "";

            const first = displayItems[0];
            const second = displayItems[1];

            const label1 = FEATURE_LABELS[first.feature] || first.feature;
            const dir1 = first.cluster_mean > first.global_mean ? "åé«˜" : "åä½";

            if (!second) {
                return `é€™ç¾¤äººåœ¨ã€Œ${label1}ã€ä¸Šæ˜é¡¯${dir1}ã€‚`;
            }

            const label2 = FEATURE_LABELS[second.feature] || second.feature;
            const dir2 = second.cluster_mean > second.global_mean ? "åé«˜" : "åä½";

            return `é€™ç¾¤äººã€Œ${label1}ã€${dir1}ï¼Œä¸”ã€Œ${label2}ã€${dir2}ï¼Œæ˜¯å¾ˆæœ‰ä»£è¡¨æ€§çš„è¼ªå»“ã€‚`;
        }




        let lastClusterData = null;
        let activeCharts = []; // ç”¨ä¾†ç®¡ç†åœ–è¡¨å¯¦ä¾‹ï¼Œé¿å…åˆ‡æ›æ™‚è¨˜æ†¶é«”æ®˜ç•™
        let overallPerfChart = null; // â­ æ–°å¢ï¼šæ‰€æœ‰ç¾¤å¹³å‡ç¸¾æ•ˆçš„ chart
        let multiRadarChart = null;        // å·¦å´å°å¼µé›·é”åœ–
        let multiRadarChartLarge = null;   // æ”¾å¤§ç‰ˆé›·é”åœ–






        function formatNumber(x, digits = 1) {
            if (x === null || x === undefined || Number.isNaN(x)) return "-";
            return Number(x).toFixed(digits);
        }

        let snapshotData = null;   // å„²å­˜å¿«ç…§ç”¨
        let snapshotMeta = null;   // å¿«ç…§çš„æ‘˜è¦è³‡è¨Šï¼ˆæ–¹ä¾¿é¡¯ç¤ºæ¯”è¼ƒï¼‰

        function deepClone(obj) {
            if (!obj) return obj;
            if (window.structuredClone) return structuredClone(obj);
            return JSON.parse(JSON.stringify(obj));
        }




        // å®šç¾©æ¯å€‹ä¸»é¡Œè¦çœ‹å“ªäº›æ¬„ä½
        function getThemeKeys(globalMeans) {
            const themeSelect = document.getElementById("theme-select");
            const theme = themeSelect ? themeSelect.value : "workload";

            let keys;
            if (theme === "workload") {
                keys = ["Work_Hours_Per_Week", "Overtime_Hours", "Projects_Handled", "Sick_Days"];
            } else if (theme === "pay") {
                keys = ["Monthly_Salary", "Years_At_Company", "Age"];
            } else if (theme === "growth") {
                keys = ["Training_Hours", "Employee_Satisfaction_Score"];
            } else if (theme === "team") {
                keys = ["Team_Size", "Remote_Work_Frequency"];
            } else {
                // é¸å…¨éƒ¨æ™‚ï¼Œé¡¯ç¤ºå¾Œç«¯å›å‚³çš„æ‰€æœ‰ç‰¹å¾µ
                keys = Object.keys(globalMeans || {});
            }
            // éæ¿¾æ‰ä¸å­˜åœ¨æ–¼ globalMeans çš„ keyï¼Œé¿å…å ±éŒ¯
            return keys.filter(
                (k) => globalMeans && Object.prototype.hasOwnProperty.call(globalMeans, k)
            );
        }

        function evaluateClusterQuality(data) {
            const clusters = data.clusters || [];
            if (!clusters.length) return null;

            const k = data.k || clusters.length;
            const n = data.n_samples || 0;

            const props = clusters.map(c => {
                if (typeof c.proportion === "number") return c.proportion;
                if (n > 0 && typeof c.n_samples === "number") return c.n_samples / n;
                return 0;
            });

            const perfs = clusters.map(c => c.mean_performance ?? 0);

            const minP = Math.min(...props);
            const maxP = Math.max(...props);
            const perfRange = Math.max(...perfs) - Math.min(...perfs);

            let level = "good";
            const reasons = [];

            // æœ‰è¶…å°ç¾¤æˆ–è¶…å¤§ç¾¤
            if (minP < 0.03 || maxP > 0.60) {
                level = "ok";
                reasons.push("æœ‰äººæ•¸æ¥µå°æˆ–æ¥µå¤§çš„ç¾¤");
            }

            // ç¾¤é–“ç¸¾æ•ˆå·®ç•°å¤ªå°
            if (perfRange < 0.25) {
                level = level === "good" ? "ok" : "bad";
                reasons.push("å„ç¾¤å¹³å‡ç¸¾æ•ˆå·®ç•°ä¸å¤§");
            }

            // k å¤ªå¤§ï¼Œå®¹æ˜“ over-segmentation
            if (k > 8) {
                level = level === "good" ? "ok" : "bad";
                reasons.push("åˆ†ç¾¤æ•¸åå¤šï¼Œå¯èƒ½éåº¦åˆ‡å‰²");
            }

            return {
                level,
                k,
                minP,
                maxP,
                perfRange,
                reasonText: reasons.length
                    ? reasons.join("ã€")
                    : "ç¾¤æ•¸åˆ†å¸ƒèˆ‡ç¸¾æ•ˆå·®ç•°éƒ½é‚„ç®—æ¸…æ¥š",
            };
        }

        function updateClusterQualityPill(data) {
            const pill = document.getElementById("cluster-quality-pill");
            if (!pill) return;

            const q = evaluateClusterQuality(data);
            if (!q) {
                pill.className = "quality-pill quality-na";
                pill.textContent = "å“è³ªï¼šå°šæœªåˆ†æ";
                pill.title = "";
                return;
            }

            let label;
            if (q.level === "good") label = "å“è³ªï¼šğŸŸ¢ ç©©å®š";
            else if (q.level === "ok") label = "å“è³ªï¼šğŸŸ¡ å¾…è§€å¯Ÿ";
            else label = "å“è³ªï¼šğŸ”´ å»ºè­°èª¿æ•´";

            pill.className = `quality-pill quality-${q.level}`;
            pill.textContent = label;
            pill.title =
                `k = ${q.k}ï¼›æœ€å°ç¾¤ç´„ ${(q.minP * 100).toFixed(1)}%` +
                `ï¼Œæœ€å¤§ç¾¤ç´„ ${(q.maxP * 100).toFixed(1)}%ï¼Œ` +
                `å„ç¾¤å¹³å‡ç¸¾æ•ˆå·®è·ç´„ ${q.perfRange.toFixed(2)} åˆ†ã€‚\n` +
                q.reasonText;
        }

        function clusterDisplayName(c) {
            return c.display_name || `ç¬¬ ${c.cluster_id + 1} ç¾¤`;
        }

        /** å»ºç«‹ã€Œå¤šç¾¤é›·é”åœ–ã€çš„ Chart.js è¨­å®šï¼Œçµ¦å°åœ– & æ”¾å¤§åœ–å…±ç”¨ */
        function buildMultiRadarConfig(clusters, globalMeans) {
            const featureKeys = Object.keys(globalMeans || {});
            const labelsRadar = featureKeys.map((k) => FEATURE_LABELS[k] || k);

            // æ²’æœ‰ç‰¹å¾µå°±çµ¦ä¸€å€‹ç©ºåœ–ï¼Œé¿å…å ±éŒ¯
            if (!featureKeys.length || !clusters.length) {
                return {
                    type: "radar",
                    data: { labels: [], datasets: [] },
                    options: { responsive: true, maintainAspectRatio: false },
                };
            }

            // çµ¦ä¸åŒç¾¤ä¸€çµ„é¡è‰²
            const fillColors = [
                "rgba(34, 197, 94, 0.28)",   // ç¶ 
                "rgba(59, 130, 246, 0.28)",  // è—
                "rgba(245, 158, 11, 0.28)",  // æ©˜
                "rgba(244, 63, 94, 0.28)",   // æ¡ƒç´…
                "rgba(139, 92, 246, 0.28)",  // ç´«
                "rgba(14, 165, 233, 0.28)",  // é’
            ];
            const borderColors = [
                "rgba(22, 163, 74, 1)",
                "rgba(37, 99, 235, 1)",
                "rgba(217, 119, 6, 1)",
                "rgba(190, 24, 93, 1)",
                "rgba(124, 58, 237, 1)",
                "rgba(2, 132, 199, 1)",
            ];

            const datasets = clusters.map((c, idx) => {
                const fm = c.feature_means || {};
                const data = featureKeys.map((key) => {
                    const g = globalMeans[key];
                    const v = fm[key];
                    if (g == null || g === 0 || v == null) return 1; // æ²’è³‡æ–™å…ˆç•¶ä½œæ¥è¿‘å¹³å‡
                    return v / g; // æ¯”ä¾‹ï¼šæœ¬ç¾¤ / å…¨é«”
                });

                return {
                    label: clusterDisplayName(c),
                    data,
                    backgroundColor: fillColors[idx % fillColors.length],
                    borderColor: borderColors[idx % borderColors.length],
                    borderWidth: 2,
                    pointRadius: 2,
                    pointHoverRadius: 4,
                    fill: true,
                };
            });

            return {
                type: "radar",
                data: {
                    labels: labelsRadar,
                    datasets,
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: "top",
                            labels: {
                                boxWidth: 14,
                                font: { size: 11 },
                            },
                        },
                        tooltip: {
                            callbacks: {
                                label(ctx) {
                                    const dsLabel = ctx.dataset.label || "";
                                    const v = Number(ctx.raw ?? 0);
                                    return `${dsLabel}: ${v.toFixed(2)}x`;
                                },
                            },
                        },
                    },
                    scales: {
                        r: {
                            // ä»¥ã€Œ1xã€ç‚ºä¸­å¿ƒä¸Šä¸‹å„ç•™ä¸€é»ç©ºé–“
                            suggestedMin: 0.6,
                            suggestedMax: 1.4,
                            angleLines: { color: "rgba(148, 163, 184, 0.4)" },
                            grid: { color: "rgba(148, 163, 184, 0.25)" },
                            pointLabels: {
                                font: { size: 11 },
                                color: "#111827",
                            },
                            ticks: {
                                backdropColor: "transparent",
                                showLabelBackdrop: false,
                                stepSize: 0.2,
                                callback: (v) => `${v.toFixed(1)}x`,
                            },
                        },
                    },
                },
            };
        }



        function summarizeForSnapshot(data) {
            if (!data || !data.clusters || !data.clusters.length) return null;
            const clusters = data.clusters;
            const k = data.k || clusters.length;
            const overallMean = data.overall_mean_performance ?? null;

            let best = clusters[0];
            let worst = clusters[0];
            let smallest = clusters[0];

            for (const c of clusters) {
                if (c.mean_performance > best.mean_performance) best = c;
                if (c.mean_performance < worst.mean_performance) worst = c;
                if (c.proportion < smallest.proportion) smallest = c;
            }

            return {
                k,
                overallMean,
                best: {
                    name: clusterDisplayName(best),
                    perf: best.mean_performance,
                    size: best.proportion,
                },
                worst: {
                    name: clusterDisplayName(worst),
                    perf: worst.mean_performance,
                    size: worst.proportion,
                },
                smallest: {
                    name: clusterDisplayName(smallest),
                    perf: smallest.mean_performance,
                    size: smallest.proportion,
                },
            };
        }


        // === å¿«ç…§æ¯”è¼ƒï¼šäººè©±èªªæ˜ç”¨çš„å°å·¥å…· ===

        // èªªæ˜ k å€¼æœ‰æ²’æœ‰è®Šï¼Œç®—æ˜¯å¾®èª¿é‚„æ˜¯å®Œå…¨ä¸åŒçš„åˆ‡æ³•
        function describeKChange(oldMeta, newMeta) {
            const oldK = oldMeta.k;
            const newK = newMeta.k;
            if (!Number.isFinite(oldK) || !Number.isFinite(newK)) return "";

            const delta = Math.abs(newK - oldK);
            if (delta === 0) {
                return `é€™å…©ç‰ˆéƒ½æ¡ç”¨ ${oldK} ç¾¤ï¼Œä¸»è¦æ˜¯åœ¨åŒä¸€å€‹åˆ‡æ³•ä¸Šå¾®èª¿ã€‚`;
            }

            const directionWord = newK > oldK ? "æé«˜" : "é™ä½";
            const actionWord = newK > oldK ? "åˆ‡å¾—æ›´ç´°" : "åˆä½µå¾—æ›´ç²—";

            if (delta === 1) {
                return `ç›®å‰ç‰ˆæœ¬æŠŠåˆ†ç¾¤æ•¸å¾ ${oldK} ç¾¤å°å¹…${directionWord}åˆ° ${newK} ç¾¤ï¼Œç›¸ç•¶æ–¼æŠŠåŸæœ¬çš„ç¾¤ç¨å¾®${actionWord}ã€‚`;
            }
            if (delta <= 3) {
                return `ç›®å‰ç‰ˆæœ¬æŠŠåˆ†ç¾¤æ•¸å¾ ${oldK} ç¾¤${directionWord}åˆ° ${newK} ç¾¤ï¼Œåˆ†ç¾¤æ–¹å¼æœ‰æ˜é¡¯èª¿æ•´ï¼Œå¯ä»¥çœ‹ä½œæ˜¯åŸå§‹ç‰ˆæœ¬çš„é€²ä¸€æ­¥${actionWord}ã€‚`;
            }
            return `ç›®å‰ç‰ˆæœ¬æŠŠåˆ†ç¾¤æ•¸å¾ ${oldK} ç¾¤ä¸€æ¬¡${directionWord}åˆ° ${newK} ç¾¤ï¼Œå·²ç¶“æ˜¯å®Œå…¨ä¸åŒçš„åˆ‡æ³•ï¼Œå»ºè­°æŠŠå®ƒç•¶æˆå¦ä¸€å€‹ç‰ˆæœ¬ä¾†çœ‹ã€‚`;
        }

        // èªªæ˜åˆ†æ•¸å·®å¤šå°‘ï¼ˆé«˜ç¸¾æ•ˆç¾¤ã€ä½ç¸¾æ•ˆç¾¤å…±ç”¨ï¼‰
        function describeScoreChange(newVal, oldVal) {
            if (newVal == null || oldVal == null) return "";
            const diff = newVal - oldVal;
            const abs = Math.abs(diff);

            if (abs < 0.05) {
                return "åˆ†æ•¸å¹¾ä¹ä¸€æ¨£ï¼Œå¯ä»¥è¦–ç‚ºåŒä¸€å±¤ç´šã€‚";
            }

            const trend = diff > 0 ? "ç›®å‰ç‰ˆæœ¬ç•¥é«˜ä¸€äº›" : "ç›®å‰ç‰ˆæœ¬ç•¥ä½ä¸€äº›";
            if (abs < 0.15) {
                return `${trend}ï¼ˆç´„å·® ${abs.toFixed(2)} åˆ†ï¼‰ã€‚`;
            }
            return `${trend}ï¼Œå·®è·æ¯”è¼ƒæ˜é¡¯ï¼ˆç´„å·® ${abs.toFixed(2)} åˆ†ï¼‰ã€‚`;
        }

        // èªªæ˜ã€Œæœ€å°æ—ç¾¤ã€çš„äººæ•¸æ¯”ä¾‹æœ‰æ²’æœ‰å·®å¾ˆå¤š
        function describeSizeChange(newSize, oldSize) {
            if (newSize == null || oldSize == null) return "";
            const diffPct = (newSize - oldSize) * 100;
            const abs = Math.abs(diffPct);

            if (abs < 3) {
                return "æœ€å°ç¾¤çš„äººæ•¸æ¯”ä¾‹å·®ä¸å¤šï¼Œå¯è¦–ç‚ºé¡ä¼¼è¦æ¨¡ã€‚";
            }

            const bigger = diffPct > 0;
            const baseText = bigger
                ? "ç›®å‰ç‰ˆæœ¬çš„æœ€å°ç¾¤ä½”æ¯”ç¨å¾®æ›´å¤§"
                : "ç›®å‰ç‰ˆæœ¬çš„æœ€å°ç¾¤ä½”æ¯”æ›´å°";

            if (abs < 8) {
                return `${baseText}ï¼ˆç´„å·® ${abs.toFixed(1)} å€‹ç™¾åˆ†é»ï¼‰ã€‚`;
            }
            return `${baseText}ï¼Œå·®ç•°æ¯”è¼ƒæ˜é¡¯ï¼ˆç´„å·® ${abs.toFixed(1)} å€‹ç™¾åˆ†é»ï¼‰ã€‚`;
        }

        // æŠŠåˆ†ç¾¤å“è³ªç­‰ç´šè½‰æˆä¸€å¥å¥½è®€çš„æ¨™ç±¤
        function qualityLevelLabel(level) {
            if (level === "good") return "ğŸŸ¢ ç©©å®š";
            if (level === "ok") return "ğŸŸ¡ å¾…è§€å¯Ÿ";
            if (level === "bad") return "ğŸ”´ å»ºè­°èª¿æ•´";
            return "å°šæœªåˆ†æ";
        }




        function saveSnapshot() {
            if (!lastClusterData || !lastClusterData.clusters || !lastClusterData.clusters.length) {
                alert("ç›®å‰æ²’æœ‰å¯ä»¥å„²å­˜çš„åˆ†ç¾¤çµæœã€‚");
                return;
            }
            snapshotData = deepClone(lastClusterData);
            snapshotMeta = summarizeForSnapshot(snapshotData);

            const labelEl = document.getElementById("snapshot-label");
            if (snapshotMeta && labelEl) {
                labelEl.textContent =
                    `å·²å„²å­˜å¿«ç…§ï¼šk = ${snapshotMeta.k}ï¼Œæ•´é«”å¹³å‡ç´„ ` +
                    `${formatNumber(snapshotMeta.overallMean, 2)} åˆ†`;
            }

            const compareBtn = document.getElementById("btn-compare-snapshot");
            if (compareBtn) compareBtn.disabled = false;

            const compareCard = document.getElementById("snapshot-compare-card");
            if (compareCard) compareCard.style.display = "none";
        }

        function compareSnapshot() {
            const cardEl = document.getElementById("snapshot-compare-card");
            const bodyEl = document.getElementById("snapshot-compare-body");
            if (!cardEl || !bodyEl) return;

            // æ²’æœ‰å¿«ç…§æˆ–ç›®å‰é‚„æ²’åˆ†ç¾¤æ™‚ï¼Œå…ˆçµ¦æ˜ç¢ºæç¤º
            if (!snapshotData || !lastClusterData) {
                alert("è«‹å…ˆå„²å­˜ä¸€å€‹å¿«ç…§ï¼Œå†é€²è¡Œæ¯”è¼ƒã€‚");
                cardEl.style.display = "none";
                return;
            }

            const a = summarizeForSnapshot(snapshotData);      // å¿«ç…§ç‰ˆ
            const b = summarizeForSnapshot(lastClusterData);   // ç›®å‰ç‰ˆ

            // è³‡æ–™æ€ªæ€ªçš„æ™‚å€™ï¼Œä¸è¦éœé»˜å¤±æ•—ï¼Œç›´æ¥é¡¯ç¤ºèªªæ˜
            if (!a || !b) {
                bodyEl.innerHTML = `
            <p>ç›®å‰çš„åˆ†ç¾¤è³‡æ–™ä¸è¶³ä»¥æ¯”è¼ƒï¼Œè«‹é‡æ–°åŸ·è¡Œåˆ†ç¾¤ä¸¦å†å­˜ä¸€æ¬¡å¿«ç…§ã€‚</p>
        `;
                cardEl.style.display = "block";
                return;
            }

            // 1ï¼‰k å€¼æœ‰æ²’æœ‰è®Šã€ç®—å¾®èª¿é‚„æ˜¯å®Œå…¨ä¸åŒ
            const kSentence = describeKChange(a, b);

            // 2ï¼‰æ•´é«”å¹³å‡ç¸¾æ•ˆçš„å·®ç•°ï¼ˆé€šå¸¸æœƒå¾ˆå°ï¼Œç›´æ¥å¹«ä½ ç¿»è­¯ï¼‰
            let overallSentence = "";
            if (a.overallMean != null && b.overallMean != null) {
                const diff = b.overallMean - a.overallMean;
                const abs = Math.abs(diff);
                const oldText = formatNumber(a.overallMean, 2);
                const newText = formatNumber(b.overallMean, 2);

                if (abs < 0.02) {
                    overallSentence = `å…©ç‰ˆçš„æ•´é«”å¹³å‡ç¸¾æ•ˆå¹¾ä¹ä¸€æ¨£ï¼ˆå¿«ç…§ç´„ ${oldText} åˆ†ï¼Œç›®å‰ç´„ ${newText} åˆ†ï¼‰ï¼Œä»£è¡¨åªæ˜¯æ›äº†ä¸€ç¨®çœ‹è³‡æ–™çš„è§’åº¦ï¼Œæ•´é«”è¡¨ç¾æ²’æœ‰è®Šã€‚`;
                } else {
                    const trend = diff > 0 ? "ç•¥é«˜" : "ç•¥ä½";
                    const strength = abs < 0.1 ? "äº›å¾®" : "æ¯”è¼ƒæ˜é¡¯";
                    overallSentence = `ç›®å‰ç‰ˆæœ¬çš„æ•´é«”å¹³å‡ç¸¾æ•ˆ${trend}æ–¼å¿«ç…§ç‰ˆ${strength}ï¼ˆå¾ç´„ ${oldText} åˆ†åˆ° ${newText} åˆ†ï¼Œå·®ç´„ ${abs.toFixed(2)} åˆ†ï¼‰ã€‚`;
                }
            }

            // 3ï¼‰é«˜ç¸¾æ•ˆç¾¤ã€ä½ç¸¾æ•ˆç¾¤ã€æœ€å°æ—ç¾¤äººæ•¸çš„å·®ç•°ï¼Œç”¨äººè©±è§£é‡‹
            const bestDetail = describeScoreChange(b.best.perf, a.best.perf);
            const worstDetail = describeScoreChange(b.worst.perf, a.worst.perf);
            const sizeDetail = describeSizeChange(b.smallest.size, a.smallest.size);

            // 4ï¼‰åŠ ä¸Šã€Œå“è³ªç°¡è©•ã€ï¼šé€™ç‰ˆæ¯”è¼ƒé©åˆç•¶æ­£å¼ç‰ˆæœ¬ï¼Œé‚„æ˜¯ç•¶åƒè€ƒ
            let qualitySentence = "";
            const qa = evaluateClusterQuality(snapshotData);
            const qb = evaluateClusterQuality(lastClusterData);
            if (qa && qb) {
                const order = { bad: 1, ok: 2, good: 3 };
                const diffLevel = (order[qb.level] || 0) - (order[qa.level] || 0);

                if (diffLevel > 0) {
                    qualitySentence =
                        `å“è³ªç°¡è©•ï¼šå¿«ç…§ç‰ˆç´„ç‚ºã€Œ${qualityLevelLabel(qa.level)}ã€ï¼Œ` +
                        `ç›®å‰ç‰ˆç´„ç‚ºã€Œ${qualityLevelLabel(qb.level)}ã€ï¼Œ` +
                        `ç›®å‰ç‰ˆåœ¨äººæ•¸åˆ†å¸ƒèˆ‡ç¸¾æ•ˆå·®ç•°ä¸Šç›¸å°æ›´æ¸…æ¥šï¼ˆ${qb.reasonText}ï¼‰ï¼Œ` +
                        `å¦‚æœè¦æ‹¿ä¾†åšç°¡å ±æˆ–æ­£å¼è¨è«–ï¼Œå¯ä»¥å„ªå…ˆè€ƒæ…®ç›®å‰é€™ä¸€ç‰ˆã€‚`;
                } else if (diffLevel < 0) {
                    qualitySentence =
                        `å“è³ªç°¡è©•ï¼šå¿«ç…§ç‰ˆç´„ç‚ºã€Œ${qualityLevelLabel(qa.level)}ã€ï¼Œ` +
                        `ç›®å‰ç‰ˆç´„ç‚ºã€Œ${qualityLevelLabel(qb.level)}ã€ï¼Œ` +
                        `å¿«ç…§ç‰ˆåœ¨ç©©å®šåº¦ä¸Šç•¥å‹ä¸€ç±Œï¼Œè‹¥å¸Œæœ›ç‰ˆæœ¬æ¯”è¼ƒä¿å®ˆï¼Œå¯ä»¥ä»¥å¿«ç…§ç‰ˆç‚ºä¸»ï¼ˆ${qa.reasonText}ï¼‰ã€‚`;
                } else {
                    qualitySentence =
                        `å“è³ªç°¡è©•ï¼šå…©ç‰ˆåˆ†ç¾¤å“è³ªå·®ä¸å¤šï¼ˆçš†ç‚ºã€Œ${qualityLevelLabel(qb.level)}ã€ï¼‰ï¼Œ` +
                        `å¯ä»¥ä¾ä½ æƒ³å¼·èª¿çš„ä¸»é¡Œä¾†é¸ç”¨ï¼šä¾‹å¦‚ä¸€ç‰ˆçœ‹èµ·ä¾†ç¾¤æ•¸è¼ƒç°¡æ½”ã€å¦ä¸€ç‰ˆå‰‡æŠŠæ—ç¾¤åˆ‡å¾—æ›´ç´°ã€‚`;
                }
            }

            // 5ï¼‰çµ„è£æˆå¥½è®€çš„ HTML
            const htmlParts = [];

            htmlParts.push(`<p>${kSentence}</p>`);
            if (overallSentence) {
                htmlParts.push(`<p>${overallSentence}</p>`);
            }

            htmlParts.push(`
        <ul>
            <li>
                <strong>é«˜ç¸¾æ•ˆæ—ç¾¤ï¼š</strong>
                å¿«ç…§ç‰ˆç‚ºã€Œ${a.best.name}ã€å¹³å‡ç´„ ${formatNumber(a.best.perf, 2)} åˆ†ï¼Œ
                ç›®å‰ç‰ˆç‚ºã€Œ${b.best.name}ã€å¹³å‡ç´„ ${formatNumber(b.best.perf, 2)} åˆ†ã€‚
                ${bestDetail}
            </li>
            <li>
                <strong>éœ€é—œæ³¨æ—ç¾¤ï¼ˆæœ€ä½ç¸¾æ•ˆï¼‰ï¼š</strong>
                å¿«ç…§ç‰ˆç‚ºã€Œ${a.worst.name}ã€å¹³å‡ç´„ ${formatNumber(a.worst.perf, 2)} åˆ†ï¼Œ
                ç›®å‰ç‰ˆç‚ºã€Œ${b.worst.name}ã€å¹³å‡ç´„ ${formatNumber(b.worst.perf, 2)} åˆ†ã€‚
                ${worstDetail}
            </li>
            <li>
                <strong>æœ€å°æ—ç¾¤äººæ•¸ï¼š</strong>
                å¿«ç…§ç‰ˆç´„ ${(a.smallest.size * 100).toFixed(1)}%ï¼Œ
                ç›®å‰ç‰ˆç´„ ${(b.smallest.size * 100).toFixed(1)}%ã€‚${sizeDetail}
            </li>
        </ul>
    `);

            if (qualitySentence) {
                htmlParts.push(`<p class="note">${qualitySentence}</p>`);
            }

            bodyEl.innerHTML = htmlParts.join("");
            cardEl.style.display = "block";
        }





        // --- æª¢æŸ¥æ¨¡å‹ç‹€æ…‹ ---
        async function checkModelStatus() {
            const statusEl = document.getElementById("model-status");

            // â­ ä¸€é–‹å§‹å°±æ˜èªªã€Œæ­£åœ¨æª¢æŸ¥ã€
            statusEl.className = "status-pill warn";
            statusEl.textContent = "â³ æ­£åœ¨æª¢æŸ¥æ¨¡å‹ç‹€æ…‹â€¦";


            try {
                const res = await fetch(`${API_BASE}/api/model_summary`);
                if (!res.ok) {
                    statusEl.className = "status-pill warn";
                    statusEl.textContent = "âš  ç³»çµ±å°šæœªåµæ¸¬åˆ°å·²è¨“ç·´æ¨¡å‹ï¼Œè«‹å…ˆåˆ° Demo é æŒ‰ã€Œå»ºç«‹æ¨¡å‹ã€ã€‚";
                    return;
                }
                const data = await res.json();
                if (data.has_model) {
                    statusEl.className = "status-pill ok";
                    statusEl.textContent = "âœ… å·²åµæ¸¬åˆ°å·²è¨“ç·´æ¨¡å‹ï¼Œå¯ç›´æ¥åœ¨ä¸‹æ–¹èª¿æ•´ k å€¼åˆ†ç¾¤ã€‚";
                } else {
                    statusEl.className = "status-pill warn";
                    statusEl.textContent = "âš  å°šæœªåµæ¸¬åˆ°å·²è¨“ç·´æ¨¡å‹ï¼Œè«‹å…ˆåˆ° Demo é æŒ‰ã€Œå»ºç«‹æ¨¡å‹ã€ã€‚";
                }
            } catch (err) {
                console.error(err);
                statusEl.className = "status-pill warn";
                statusEl.textContent = "âš  æª¢æŸ¥æ¨¡å‹ç‹€æ…‹å¤±æ•—ï¼Œè«‹ç¢ºèªå¾Œç«¯æ˜¯å¦å•Ÿå‹•ã€‚";
            }
        }

        // --- k å€¼æŒ‰éˆ•äº’å‹• ---
        const kInput = document.getElementById("k-input");
        const kPills = document.querySelectorAll(".k-pill");

        kPills.forEach(btn => {
            btn.addEventListener("click", () => {
                const k = Number(btn.dataset.k);
                kInput.value = k;
                kPills.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
            });
        });

        kInput.addEventListener("input", () => {
            const val = Number(kInput.value);
            kPills.forEach(b => {
                if (Number(b.dataset.k) === val) {
                    b.classList.add("active");
                } else {
                    b.classList.remove("active");
                }
            });
        });

        // --- å‘¼å«å¾Œç«¯åˆ†ç¾¤ API ---
        async function runCluster() {
            const btn = document.getElementById("btn-run-cluster");
            const statusText = document.getElementById("cluster-status");
            const k = Number(kInput.value || "3");

            if (!Number.isFinite(k) || k < 2) {
                alert("è«‹è¼¸å…¥åˆç†çš„åˆ†ç¾¤æ•¸ï¼ˆè‡³å°‘ 2 ç¾¤ï¼‰ã€‚");
                return;
            }

            btn.disabled = true;
            btn.textContent = "åˆ†ç¾¤ä¸­â€¦";
            statusText.textContent = "åˆ†ç¾¤ä¸­ï¼Œè«‹ç¨å€™â€¦";

            try {
                const res = await fetch(`${API_BASE}/api/cluster_sandbox`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ k }),
                });
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(`HTTP ${res.status}: ${text}`);
                }
                const data = await res.json();
                renderClusterResult(data);
            } catch (err) {
                console.error(err);
                alert(`åˆ†ç¾¤å¤±æ•—ï¼š${err.message}`);
                statusText.textContent = "åˆ†ç¾¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æ˜¯å¦å•Ÿå‹•ã€‚";
            } finally {
                btn.disabled = false;
                btn.textContent = "ğŸ”„ é‡æ–°åˆ†ç¾¤";
            }
        }


        // --- æ ¸å¿ƒï¼šæ¸²æŸ“çµæœä¸¦ç¹ªè£½åœ–è¡¨ ---
        function renderClusterResult(data) {
            lastClusterData = data;

            // åˆ†ç¾¤å“è³ªå°ç‡ˆè™Ÿ
            updateClusterQualityPill(data);

            // å…ˆæŠŠèˆŠåœ–åˆªæ‰
            activeCharts.forEach((chart) => chart.destroy());
            activeCharts = [];
            if (overallPerfChart) {
                overallPerfChart.destroy();
                overallPerfChart = null;
            }
            if (multiRadarChart) {
                multiRadarChart.destroy();
                multiRadarChart = null;
            }

            const summaryEl = document.getElementById("cluster-summary");
            const listWrapper = document.getElementById("cluster-list-wrapper");
            const statusText = document.getElementById("cluster-status");

            const k = data.k;
            const n = data.n_samples;
            const overallMean = data.overall_mean_performance;
            const clusters = data.clusters || [];
            const globalMeans = data.feature_means_global || {};

            // Step 2 ä¸Šæ–¹æ–‡å­—æ‘˜è¦
            summaryEl.innerHTML = `
        <h3>å·²å®Œæˆ ${k} ç¾¤åˆ†ç¾¤</h3>
        <p>å…± ${n} ç­†å“¡å·¥è³‡æ–™ï¼Œæ•´é«”å¹³å‡ç¸¾æ•ˆç´„ç‚º ${formatNumber(
                overallMean,
                3
            )} åˆ†ã€‚ä¸‹æ–¹ä¾ç…§ã€Œå„ç¾¤å¹³å‡ç¸¾æ•ˆã€ç”±é«˜åˆ°ä½æ’åˆ—ã€‚</p>
    `;
            statusText.textContent = `å·²å®Œæˆ ${k} ç¾¤åˆ†ç¾¤ï¼Œå¯å¤šæ¬¡èª¿æ•´ k å€¼èˆ‡è§€å¯Ÿä¸»é¡Œï¼Œçœ‹çœ‹è¼ªå»“æ€éº¼è®Šã€‚`;

            const container = document.createElement("div");
            container.className = "cluster-list";

            // === æ•´é«” baseline å°å¡ ===
            const baselineBox = document.createElement("div");
            baselineBox.className = "cluster-baseline-box";
            baselineBox.innerHTML =
                '<div class="cluster-baseline-title">æ•´é«”å¹³å‡æ¦‚æ³ï¼ˆæ¯”è¼ƒåŸºæº–ï¼‰</div>';

            const baselineList = document.createElement("ul");
            baselineList.className = "cluster-baseline-list";

            const focusKeys = getThemeKeys(globalMeans);
            if (!focusKeys.length) {
                baselineList.innerHTML = "<li>ç›®å‰æ²’æœ‰å¯ç”¨çš„æ•¸å€¼ç‰¹å¾µå¯ä»¥æ¯”è¼ƒã€‚</li>";
            } else {
                focusKeys.forEach((key) => {
                    const li = document.createElement("li");
                    const label = FEATURE_LABELS[key] || key;
                    li.textContent = `${label}ï¼šå…¨é«”å¹³å‡ç´„ ${formatNumber(
                        globalMeans[key]
                    )}`;
                    baselineList.appendChild(li);
                });
            }
            baselineBox.appendChild(baselineList);
            container.appendChild(baselineBox);

            // === å„ç¾¤å¡ç‰‡ï¼ˆåªç•™æ–‡å­—ï¼‹ã€Œèˆ‡å¹³å‡å·®ç•°%ã€æ©«æ¢åœ–ï¼‰ ===
            clusters.forEach((c) => {
                const card = document.createElement("div");
                card.className = "cluster-card";

                const header = document.createElement("div");
                header.className = "cluster-header";

                const titleText = c.research_name
                    ? `${c.research_name}ï¼ˆ${c.display_name || `ç¬¬ ${c.cluster_id + 1} ç¾¤`
                    }ï¼‰`
                    : c.display_name || `ç¬¬ ${c.cluster_id + 1} ç¾¤`;

                header.innerHTML = `
            <div class="cluster-name">${titleText}</div>
            <div class="cluster-tag">${c.rank_label || "å¹³å‡ç¸¾æ•ˆè¼ªå»“"}</div>
        `;
                card.appendChild(header);

                const body = document.createElement("div");
                body.className = "cluster-body";
                body.innerHTML = `
            <p>äººæ•¸ï¼šç´„ ${c.n_samples} äººï¼ˆç´„ä½” ${(c.proportion * 100).toFixed(
                    1
                )}%ï¼‰</p>
            <p>å¹³å‡ç¸¾æ•ˆï¼šç´„ ${formatNumber(c.mean_performance, 3)} åˆ†</p>
            <p>ç›¸å°ä½ç½®ï¼šç´„è½åœ¨å…¨é«”çš„ç¬¬ ${(c.mean_percentile * 100).toFixed(
                    1
                )} ç™¾åˆ†ä½</p>
        `;

                // äººæ•¸æ¯”ä¾‹å°æ¢
                const sizeBarWrap = document.createElement("div");
                sizeBarWrap.style.margin = "4px 0 6px";
                sizeBarWrap.style.fontSize = "0.85rem";

                const barOuter = document.createElement("div");
                barOuter.style.height = "6px";
                barOuter.style.borderRadius = "999px";
                barOuter.style.background = "#e5e7eb";
                barOuter.style.overflow = "hidden";

                const barInner = document.createElement("div");
                barInner.style.height = "100%";
                barInner.style.width = `${(c.proportion * 100).toFixed(1)}%`;
                barInner.style.borderRadius = "999px";
                barInner.style.background = "#0f766e";

                barOuter.appendChild(barInner);
                sizeBarWrap.textContent = "æ­¤ç¾¤ä½”æ•´é«”äººæ•¸æ¯”ä¾‹ï¼š";
                sizeBarWrap.appendChild(barOuter);
                body.appendChild(sizeBarWrap);

                if (c.comment) {
                    const p4 = document.createElement("p");
                    p4.textContent = c.comment;
                    body.appendChild(p4);
                }

                // æ¯ç¾¤å°ç¸¾æ•ˆæ¢
                const perfWrap = document.createElement("div");
                perfWrap.className = "cluster-perf-bar-wrap";

                const barBg = document.createElement("div");
                barBg.className = "cluster-perf-bar-bg";

                const barFill = document.createElement("div");
                barFill.className = "cluster-perf-bar-fill";

                const ratio = overallMean ? c.mean_performance / overallMean : 0;
                const ratioClamped = Math.max(0.4, Math.min(ratio, 1.6));
                const widthPercent = (ratioClamped / 1.6) * 100;

                barFill.style.width = `${widthPercent}%`;
                barFill.style.background =
                    ratio >= 1
                        ? "linear-gradient(to right, #22c55e, #16a34a)"
                        : "linear-gradient(to right, #f97316, #ea580c)";

                barBg.appendChild(barFill);

                const barLabel = document.createElement("div");
                barLabel.className = "cluster-perf-bar-label";
                barLabel.textContent = `ç›¸å°æ•´é«”å¹³å‡ï¼šç´„ ${(ratio * 100).toFixed(0)}%`;

                perfWrap.appendChild(barBg);
                perfWrap.appendChild(barLabel);
                body.appendChild(perfWrap);

                // ç‰¹å¾µè¼ªå»“ï¼ˆèˆ‡å¹³å‡å·®ç•° % çš„æ©«æ¢åœ–ï¼‰
                const featureBlock = document.createElement("div");
                featureBlock.className = "cluster-feature-block";

                const fTitle = document.createElement("div");
                fTitle.className = "cluster-feature-title";
                fTitle.textContent = "ç‰¹å¾µè¼ªå»“åˆ†æï¼ˆèˆ‡æ•´é«”å·®ç•° %ï¼‰";
                featureBlock.appendChild(fTitle);

                const diffs = c.top_feature_diff || [];
                const themeKeys = getThemeKeys(globalMeans);
                let displayItems = [];

                if (themeKeys.length) {
                    displayItems = diffs.filter((d) => themeKeys.includes(d.feature));
                } else {
                    displayItems = diffs.slice(0, 10);
                }

                if (displayItems.length > 0) {
                    const chartContainer = document.createElement("div");
                    chartContainer.style.marginTop = "10px";
                    chartContainer.style.height = `${displayItems.length * 35 + 50}px`;
                    chartContainer.style.position = "relative";

                    const canvas = document.createElement("canvas");
                    chartContainer.appendChild(canvas);
                    featureBlock.appendChild(chartContainer);

                    const labels = displayItems.map(
                        (d) => FEATURE_LABELS[d.feature] || d.feature
                    );
                    const percentages = displayItems.map((d) => {
                        if (!d.global_mean) return 0;
                        return (
                            ((d.cluster_mean - d.global_mean) / d.global_mean) * 100
                        );
                    });
                    const rawValues = displayItems.map((d) => ({
                        c: d.cluster_mean,
                        g: d.global_mean,
                    }));

                    const ctx = canvas.getContext("2d");
                    const newChart = new Chart(ctx, {
                        type: "bar",
                        data: {
                            labels,
                            datasets: [
                                {
                                    label: "èˆ‡å¹³å‡å·®ç•° (%)",
                                    data: percentages,
                                    backgroundColor: percentages.map((v) =>
                                        v >= 0
                                            ? "rgba(34, 197, 94, 0.7)"
                                            : "rgba(239, 68, 68, 0.7)"
                                    ),
                                    borderColor: percentages.map((v) =>
                                        v >= 0
                                            ? "rgba(34, 197, 94, 1)"
                                            : "rgba(239, 68, 68, 1)"
                                    ),
                                    borderWidth: 1,
                                    borderRadius: 4,
                                    barPercentage: 0.7,
                                },
                            ],
                        },
                        options: {
                            indexAxis: "y",
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label(context) {
                                            const idx = context.dataIndex;
                                            const raw = rawValues[idx];
                                            const val = context.raw.toFixed(1);
                                            return `${val}% (æœ¬ç¾¤: ${formatNumber(
                                                raw.c
                                            )} / å…¨é«”: ${formatNumber(raw.g)})`;
                                        },
                                    },
                                },
                            },
                            scales: {
                                x: {
                                    grid: { color: "#e5e7eb" },
                                    ticks: { callback: (v) => v + "%" },
                                    suggestedMin: -10,
                                    suggestedMax: 10,
                                },
                                y: {
                                    grid: { display: false },
                                },
                            },
                        },
                    });
                    activeCharts.push(newChart);
                } else {
                    const noDataMsg = document.createElement("p");
                    noDataMsg.style.color = "#9ca3af";
                    noDataMsg.style.fontSize = "0.9rem";
                    noDataMsg.style.fontStyle = "italic";
                    noDataMsg.textContent =
                        "åœ¨æ­¤ç¾¤çµ„ä¸­ï¼Œæ‰€é¸ä¸»é¡Œçš„æŒ‡æ¨™èˆ‡å¹³å‡å€¼å·®ç•°ä¸æ˜é¡¯ã€‚";
                    featureBlock.appendChild(noDataMsg);
                }

                body.appendChild(featureBlock);
                card.appendChild(body);
                container.appendChild(card);
            });

            listWrapper.innerHTML = "";
            listWrapper.appendChild(container);

            // æ¯æ¬¡æœ‰æ–°çµæœï¼Œå°±å¯ä»¥å„²å­˜å¿«ç…§
            const snapBtn = document.getElementById("btn-save-snapshot");
            if (snapBtn) snapBtn.disabled = false;
            const compareBtn = document.getElementById("btn-compare-snapshot");
            if (compareBtn && !snapshotData) compareBtn.disabled = true;

            // ================================
            // å·¦ä¸‹ 1-4ï¼šå„ç¾¤æŒ‡æ¨™é›·é”åœ–ï¼ˆå…¨éƒ¨æ•¸å€¼ç‰¹å¾µï¼‰
            // ================================
            const radarCard = document.getElementById("radar-chart-card");
            const radarCanvas = document.getElementById("multi-radar-canvas");
            const radarNote = document.getElementById("radar-highlight-note");

            if (radarCard && radarCanvas) {
                const featureKeysAll = Object.keys(globalMeans || {});
                if (!featureKeysAll.length || !clusters.length) {
                    radarCard.style.display = "none";
                    if (radarNote) radarNote.textContent = "";
                } else {
                    radarCard.style.display = "block";

                    const rctx = radarCanvas.getContext("2d");
                    if (multiRadarChart) {
                        multiRadarChart.destroy();
                        multiRadarChart = null;
                    }

                    const cfg = buildMultiRadarConfig(clusters, globalMeans);
                    multiRadarChart = new Chart(rctx, cfg);

                    // æ‰¾å‡ºå·®ç•°æœ€å¤§çš„å¹¾å€‹æŒ‡æ¨™ï¼Œå¯«åœ¨èªªæ˜æ–‡å­—
                    const diffSummary = featureKeysAll
                        .map((key) => {
                            let maxDev = 0;
                            const g = globalMeans[key];
                            if (g == null || g === 0) return { key, maxDev: 0 };

                            clusters.forEach((c) => {
                                const fm = c.feature_means || {};
                                const v = fm[key];
                                if (v == null) return;
                                const ratio = v / g;
                                const dev = Math.abs(ratio - 1);
                                if (dev > maxDev) maxDev = dev;
                            });
                            return { key, maxDev };
                        })
                        .filter((d) => d.maxDev > 0.12); // è‡³å°‘å·® 12% æ‰è¦–ç‚ºæ˜é¡¯å·®ç•°

                    diffSummary.sort((a, b) => b.maxDev - a.maxDev);
                    const topDiff = diffSummary.slice(0, 6);
                    const highlightNames = topDiff.map(
                        (d) => FEATURE_LABELS[d.key] || d.key
                    );

                    if (radarNote) {
                        if (highlightNames.length) {
                            radarNote.textContent =
                                "å¤§ç´„åœ¨é€™å¹¾å€‹æŒ‡æ¨™ä¸Šï¼Œå„ç¾¤å·®ç•°æœ€å¤§ï¼šã€Œ" +
                                highlightNames.join("ã€") +
                                "ã€ã€‚åœ–ä¸­é›¢ 1x åœˆè¶Šé çš„åœ°æ–¹ï¼Œå·®ç•°è¶Šæ˜é¡¯ã€‚";
                        } else {
                            radarNote.textContent =
                                "åœ–ä¸Šè¶Šå‡¸å‡ºæˆ–ä½æ–¼ 1x çš„æŒ‡æ¨™ï¼Œå°±æ˜¯å„ç¾¤å·®ç•°è¼ƒå¤§çš„åœ°æ–¹ã€‚";
                        }
                    }
                }
            }

            // ================================
            // å·¦ä¸‹ 1-4ï¼šæ‰€æœ‰ç¾¤å¹³å‡ç¸¾æ•ˆç¸½è¦½åœ–ï¼ˆæ©«æ¢åœ–ï¼‰
            // ================================
            const chartCanvas = document.getElementById("overall-chart-canvas");
            if (chartCanvas) {
                const ctx = chartCanvas.getContext("2d");

                if (overallPerfChart) {
                    overallPerfChart.destroy();
                    overallPerfChart = null;
                }

                const clustersSorted = clusters
                    .slice()
                    .sort(
                        (a, b) =>
                            (b.mean_performance || 0) - (a.mean_performance || 0)
                    );

                const labels = clustersSorted.map(
                    (c) => c.display_name || `ç¬¬ ${c.cluster_id + 1} ç¾¤`
                );
                const scores = clustersSorted.map((c) => c.mean_performance);

                overallPerfChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels,
                        datasets: [
                            {
                                label: "å¹³å‡ç¸¾æ•ˆ",
                                data: scores,
                                backgroundColor: scores.map((s) =>
                                    s >= overallMean
                                        ? "rgba(34, 197, 94, 0.75)"
                                        : "rgba(56, 189, 248, 0.75)"
                                ),
                                borderColor: scores.map((s) =>
                                    s >= overallMean
                                        ? "rgba(22, 163, 74, 1)"
                                        : "rgba(37, 99, 235, 1)"
                                ),
                                borderWidth: 1,
                                borderRadius: 4,
                                barPercentage: 0.7,
                            },
                        ],
                    },
                    options: {
                        indexAxis: "y",
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) =>
                                        `å¹³å‡ç¸¾æ•ˆï¼š${formatNumber(ctx.raw, 3)} åˆ†`,
                                },
                            },
                        },
                        scales: {
                            x: {
                                grid: { color: "#e5e7eb" },
                                suggestedMin: 1,
                                suggestedMax: 5,
                            },
                            y: {
                                grid: { display: false },
                            },
                        },
                    },
                    plugins: [
                        {
                            id: "overallMeanLine",
                            afterDraw(chart) {
                                if (!overallMean) return;
                                const { ctx, chartArea, scales } = chart;
                                const xScale = scales.x;
                                if (!xScale) return;

                                const xPos = xScale.getPixelForValue(overallMean);

                                ctx.save();
                                ctx.beginPath();
                                ctx.setLineDash([6, 6]);
                                ctx.moveTo(xPos, chartArea.top + 4);
                                ctx.lineTo(xPos, chartArea.bottom - 4);
                                ctx.strokeStyle = "rgba(107, 114, 128, 0.95)";
                                ctx.lineWidth = 1.5;
                                ctx.stroke();
                                ctx.setLineDash([]);
                                ctx.restore();
                            },
                        },
                    ],
                });
            }
        }










        // åˆå§‹åŒ–ç›£è½äº‹ä»¶
        document.getElementById("btn-run-cluster").addEventListener("click", runCluster);
        checkModelStatus();

        // è§€å¯Ÿä¸»é¡Œæ”¹è®Šæ™‚ï¼Œå¦‚æœå·²æœ‰è³‡æ–™å‰‡é‡ç¹ª
        const themeSelectEl = document.getElementById("theme-select");
        if (themeSelectEl) {
            themeSelectEl.addEventListener("change", () => {
                if (lastClusterData) {
                    renderClusterResult(lastClusterData);
                }
            });
        }

        const saveSnapBtn = document.getElementById("btn-save-snapshot");
        if (saveSnapBtn) {
            saveSnapBtn.addEventListener("click", saveSnapshot);
        }

        const compareSnapBtn = document.getElementById("btn-compare-snapshot");
        if (compareSnapBtn) {
            compareSnapBtn.addEventListener("click", compareSnapshot);
        }

        // =====================
        // é›·é”åœ–æ”¾å¤§æª¢è¦– Modal
        // =====================
        const radarModalEl = document.getElementById("radar-modal");
        const btnOpenRadar = document.getElementById("btn-open-radar");
        const btnCloseRadar = document.getElementById("btn-close-radar");
        const largeRadarCanvas = document.getElementById("multi-radar-canvas-large");

        function closeRadarModal() {
            if (radarModalEl) {
                radarModalEl.style.display = "none";
            }
            if (multiRadarChartLarge) {
                multiRadarChartLarge.destroy();
                multiRadarChartLarge = null;
            }
        }

        if (btnOpenRadar && radarModalEl && largeRadarCanvas) {
            btnOpenRadar.addEventListener("click", () => {
                if (
                    !lastClusterData ||
                    !lastClusterData.clusters ||
                    !lastClusterData.clusters.length
                ) {
                    alert("è«‹å…ˆå®Œæˆä¸€æ¬¡åˆ†ç¾¤ï¼Œå†çœ‹é›·é”åœ–ã€‚");
                    return;
                }

                radarModalEl.style.display = "flex";

                const clusters = lastClusterData.clusters || [];
                const globalMeans = lastClusterData.feature_means_global || {};

                const ctx = largeRadarCanvas.getContext("2d");
                if (multiRadarChartLarge) {
                    multiRadarChartLarge.destroy();
                    multiRadarChartLarge = null;
                }
                const cfg = buildMultiRadarConfig(clusters, globalMeans);
                multiRadarChartLarge = new Chart(ctx, cfg);
            });
        }

        if (btnCloseRadar) {
            btnCloseRadar.addEventListener("click", closeRadarModal);
        }

        // é»æ¨¡ç³ŠèƒŒæ™¯æˆ–æŒ‰ Esc ä¹Ÿå¯ä»¥é—œ
        if (radarModalEl) {
            radarModalEl.addEventListener("click", (e) => {
                if (e.target === radarModalEl) {
                    closeRadarModal();
                }
            });

            window.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && radarModalEl.style.display === "flex") {
                    closeRadarModal();
                }
            });
        }



    </script>
</body>

</html>